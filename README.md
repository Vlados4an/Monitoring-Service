# MonitoringService

## Описание

Monitoring Service - это приложение, которое позволяет пользователям отправлять и просматривать показания, а администраторам просматривать аудиты и управлять типами показаний.

## Функциональность

- Регистрация новых пользователей.
- Аутентификация пользователей.
- Просмотр актуальных показаний.
- Подача показаний.
- Просмотр показаний за конкретный месяц.
- Просмотр истории подачи показаний.
- Аудит действий пользователя (регистрация, авторизация, подача показаний).
!!! Только для администраторов(Логин: admin, пароль: admin).

## Установка

Для установки проекта выполните следующие шаги:


1. Клонируйте репозиторий: `git clone https://github.com/Vlados4an/Monitoring-Service.git`
2. Перейдите в каталог проекта: `cd Monitoring-Service`
3. Поднимите контейнер базы данных ``` docker compose up -d ```
4. Соберите проект с помощью Maven: `mvn clean install`

## Использование

Для запуска приложения используйте контейнер сервлетов Tomcat не ниже 10 версии`

## Технологии

- Java 17
- Jakarta EE
- Tomcat 10
- JUnit 5
- Mockito
- Maven
- JWT
- TestContainers
- Liquibase
- JDBC
- PostgreSQL
- Aspectj
- Mapstruct
- Docker

## Структура базы данных

### `users`

| Колонка  | Тип          | Комментарий                                                                     |
|----------|--------------|---------------------------------------------------------------------------------|
| id       | bigint       | Уникальный идентификатор пользователя, первичный ключ                           |
| username | varchar(255) | Имя пользователя для входа в систему, должно быть уникальным                    |
| password | bytea        | Хешированное представление пароля пользователя, используется для аутентификации |

### `readings`

| Колонка    | Тип          | Комментарий                                                    |
|------------|--------------|----------------------------------------------------------------|
| id         | bigint       | Уникальный идентификатор показания, первичный ключ             |
| username   | varchar(255) | Имя пользователя, которому принадлежит показание, внешний ключ |
| month      | int          | Месяц периода показания, хранится как целое число              |
| year       | int          | Год периода показания, хранится как целое число                |
| heating    | double       | Показание по отоплению за данный период                        |
| cold_water | double       | Показание по холодной воде за данный период                    |
| hot_water  | double       | Показание по горячей воде за данный период                     |

### `audits`

| Колонка  | Тип          | Комментарий                                     |
|----------|--------------|-------------------------------------------------|
| id       | bigint       | Уникальный идентификатор аудита, первичный ключ |
| action   | varchar(255) | Сохраняет конкретное сообщение об аудите        |

## Servlets

#### POST `/register`

Регистрация нового игрока. Данные передаются в формате JSON:

```
{
    "username": "test",
    "password": "test"
}
```

Пример ответа:

```
{
    "message": "User with username test successfully created."
}
```

Если игрок с таким логином уже есть в базе, будет выведено следующее сообщение:

```
{
    "message": "The user with this username already exists."
}
```

#### POST `/authenticate`

Авторизация игрока в приложении. Данные передаются в формате JSON:

```
{
    "username": "test",
    "password": "test"
}
```

В ответе будет передан JWT токен для дальнейшей аутентификации игрока. Пример ответа:

```
{
    "username": "test",
    "accessToken": "eyJhbGciOiJIUzM4NCJ9.eyJzdWIiOiJ0ZXN0IiwiaWF0IjoxNzA3NDc3NzU5LCJleHAiOjE3MDc0ODEzNTl9.Cmy-hyqIW0MuW6c0SV_T3SXmDDslmLle3lOR-UWmxQmhJmZmtDOKYlEXdAnP2lkp",
    "refreshToken": "eyJhbGciOiJIUzM4NCJ9.eyJzdWIiOiJ0ZXN0IiwiaWF0IjoxNzA3NDc3NzU5LCJleHAiOjE3MTAwNjk3NTl9.WUo-R3tjy5VUmMd9mlDQu8Lxq74Sq9t10QqISzQV6dQfE1Q3KqwUYKvHPkbcx500"
}
```

#### GET `/readings/actual`

Возвращает текущие показания пользователя. Имя пользователя передается в параметрах запроса:

```
/readings/actual?username=test
```

Если параметр будет отсутствовать будет получено сообщение об ошибке:

```
{
    "message": "Username parameter is null"
}
```

Для аутентификации в необходимо передать Bearer token с полученным ранее JWT токеном.

Пример ответа:

```
{
    "username": "test",
    "month": 1,
    "year": 2022,
    "heating": 100.0,
    "coldWater": 200.0,
    "hotWater": 300.0
}
```

#### GET `/readings/history`

Возвращает историю показаний пользователя. Имя пользователя передается в параметрах запроса:

```
/readings/history?username=test
```

Если параметр будет отсутствовать будет получено сообщение об ошибке:

```
{
    "message": "Username parameter is null"
}
```

Для аутентификации в необходимо передать Bearer token с полученным ранее JWT токеном.

Пример ответа:

```
[
    {
        "month": 10,
        "year": 1999,
        "values": {
            "cold_water": 56,
            "heating": 40,
            "hot_water": 44
        }
    },
    {
        "month": 12,
        "year": 1999,
        "values": {
            "cold_water": 58,
            "heating": 40,
            "hot_water": 44
        }
    }
]
```

#### GET `/readings/month`

Возвращает показания пользователя за конкретный месяц. Имя пользователя, месяц и год передаются в параметрах запроса:

```
/readings/month?username=test&month=1&year=2022
```

Если параметр будет отсутствовать будет получено сообщение об ошибке:

```
{
    "message": "Month and year parameters must be integers!"
}
```

Для аутентификации в необходимо передать Bearer token с полученным ранее JWT токеном.

Пример ответа:

```
[
    {
        "month": 12,
        "year": 1999,
        "values": {
            "cold_water": 58,
            "heating": 40,
            "hot_water": 44
        }
    }
]
```

#### POST `/readings/submit`

Совершает подачу показаний для текущего авторизованного пользователя. Данные передаются в формате JSON:

```
{
  "username" : "test",
  "month" : 12,
  "year": 1999,
  "values": {
    "heating": 40,
    "cold_water": 58,
    "hot_water": 44
  }
}
```

Для аутентификации в необходимо передать Bearer token с полученным ранее JWT токеном.

Пример ответа:

```
{
    "message": "Reading submitted successfully!"
}
```

#### GET `/admin/audits?username=admin`

Возвращает аудит действий пользователя. Имя пользователя передается в параметрах запроса:

```
/admin/audits?username=admin
```

Если параметр будет отсутствовать будет получено сообщение об ошибке:

```
{
    "message": "Username parameter is null"
}
```

Для аутентификации в необходимо передать Bearer token с полученным ранее JWT токеном.

Пример ответа:

```
[
    {
        "id": 1,
        "audits": [
            "User authorized: "
        ]
    },
    {
        "id": 2,
        "audits": [
            "Admin viewed all audits"
        ]
    }
]
```

#### POST `/admin/add`

Добавляет новый тип показаний. Данные передаются в формате JSON:

```
{
    "username": "admin",
    "type": "gas"
}
```

Для аутентификации в необходимо передать Bearer token с полученным ранее JWT токеном.

Пример ответа:

```
{
    "message": "Reading type added successfully!"
}
```

#### POST `/admin/remove`

Удаляет тип показаний. Данные передаются в формате JSON:

```
{
    "username": "admin",
    "type": "gas"
}
```

Для аутентификации в необходимо передать Bearer token с полученным ранее JWT токеном.

Пример ответа:

```
{
    "message": "Reading type removed successfully!"
}
```

Если тип показаний не найден, будет выведено следующее сообщение:

```
{
    "message": "Reading type not found"
}
```




## Тестирование

Проект покрыт юнит-тестами JUnit, Mockito и Testcontainers. Для их запуска откройте класс с тестами, нажмите на название класса правой кнопкой мыши и выберите пункт "Run 'ClassName'".

## Тестовые данные

Приложение инициализируется с предустановленными тестовыми данными для удобства тестирования:

- Админ:
    - Имя пользователя: `admin`
    - Пароль: `admin`

- Пользователь для тестирования чтения показаний:
    - Имя пользователя: `test_user`
    - Пароль: `test_pass`
    - Показания:
        - Месяц: `1`
        - Год: `2022`
        - Отопление: `100.0`
        - Холодная вода: `200.0`
        - Горячая вода: `300.0`

## Связаться со мной:

- ssvetlaa235@gmail.com
- telegram: [@evlad03](https://t.me/evlad03)